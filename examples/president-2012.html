<!DOCTYPE html>
<meta charset="utf-8">
<style>

.states {
  fill: none;
  stroke: #fff;
  stroke-linejoin: round;
}

.overlay {
    fill: none;
    pointer-events: all;
}

</style>
<body>
<script src="//d3js.org/d3.v4.min.js"></script>
<script src="//d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<script>

var width = 960,
    height = 600;

var candidateInterpolates = {
    'R-D,RedBlue': d3.interpolateRdBu
};

function zoomed() {
    features.attr("transform", "translate(" + d3.event.transform.x +
    "," + d3.event.transform.y + ") scale(" + d3.event.transform.k + ")");
}

var zoom = d3.zoom()
    .scaleExtent([1, 2])
    .on("zoom", zoomed);

var projection = d3.geoAlbersUsa()
    .scale(1280)
    .translate([width / 2, height / 2]);
var path = d3.geoPath().projection(projection);
var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var features = svg.append("g");

svg.append("rect")
    .attr("class", "overlay")
    .attr("width", width)
    .attr("height", height)
    .call(zoom);

d3.queue()
    .defer(d3.json, "/dist/topo/us.json")
    .defer(d3.json, "/dist/elections/president/counties/2012.json")
    .defer(d3.tsv, "/dist/topo/us-state-names.tsv")
    .await(ready);

function ready(error, us, usp_2012, namesTsv) {
  if (error) throw error;

  var rateById = {};
  var votesById = {};
  var votesPerSqMiById = {};
  var names = {};
  var max = undefined;
  var min = undefined;
  var maxPerSqMi = undefined;
  var chromaticScale = d3.scaleLinear().domain([0, 0.5, 1]).range(["red", "purple", "blue"]);
  var fixedScaleById = {};
  namesTsv.forEach(d => {
     names[d.id] = d.name;
  });
  var densities = [];
  Object.keys(usp_2012.states).forEach(function(k) {
      usp_2012.states[k].counties.forEach(c => {
          if (c.fips) {
              let diff = +c.diff.percent / 2.0;
              let fips = parseInt(c.fips);
              if (c.winner === 'D') {
                  rateById[fips] = diff + .5;
                  fixedScaleById[fips] = 1;
              } else {
                  rateById[fips] = 0.5 - diff;
                  fixedScaleById[fips] = 0;
              }
              votesById[fips] = c.diff.votes;
              if (c.county.aland_sqmi && c.county.population) {
                  let sqMiles = c.county.aland_sqmi;
                  let population = c.county.population.totalEst;
                  votesPerSqMiById[fips] = (population / sqMiles);
                  if (!maxPerSqMi || votesPerSqMiById[fips] > maxPerSqMi) {
                      maxPerSqMi = votesPerSqMiById[fips];
                  }
                  densities.push(votesPerSqMiById[fips]);
              }

              if (!min || c.total < min) {
                  min = c.total;
              }
              if (!max || c.total > max) {
                  max = c.total;
              }
          }
      });
  });
  densities.sort((a, b) => a - b);

  var densityQuantile = d3.scaleLog()
    .domain([d3.quantile(densities, 0.01), d3.quantile(densities, 0.99)])
    .range([0.0, 1.0]);

  var countyData = topojson.feature(us, us.objects.counties).features;
  features.append("g")
      .attr("class", "counties")
    .selectAll("path")
      .data(countyData)
    .enter().append("path")
      .attr("d", path)
      .style("fill", function(d) {
          if (!rateById[d.id]) {
              return chromaticScale(0.5);
          }
          return chromaticScale(rateById[d.id]);
      })
      .style("fill-opacity", function (d) {
         if (!votesPerSqMiById[d.id]) {
             return 0.0;
         }
         return densityQuantile(votesPerSqMiById[d.id]);
     })
      .style("stroke", function (d) {
          if (!rateById[d.id]) {
              return chromaticScale(0.5);
          }
          return chromaticScale(fixedScaleById[d.id]);
      })
      .style("stroke-width", ".5px")
      .style("stroke-opacity", 0.1);

  features.append("path")
      .datum(topojson.mesh(us, us.objects.states, function(a, b) { return a.id !== b.id; }))
      .attr("class", "states")
      .attr("d", path)
      .style("stroke", "#fff")
      .style("stroke-width", 1.5);

}

</script>
